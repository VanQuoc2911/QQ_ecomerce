const os = require('os');
const fs = require('fs');
const path = require('path');

function pickIPv4() {
  const nets = os.networkInterfaces();
  const candidates = [];
  for (const name of Object.keys(nets)) {
    for (const net of nets[name]) {
      if (net.family !== 'IPv4' || net.internal) continue;
      // skip link-local and docker/virtual addresses
      if (net.address.startsWith('169.254.')) continue;
      if (
        net.address.startsWith('172.') &&
        !(
          net.address.startsWith('172.16') ||
          net.address.startsWith('172.17') ||
          net.address.startsWith('172.18')
        )
      ) {
        // allow common private ranges, but still accept others
      }
      candidates.push(net.address);
    }
  }
  // Prefer 192.168.x.x, then 10.x.x.x, then any
  const prefer =
    candidates.find(a => a.startsWith('192.168.')) ||
    candidates.find(a => a.startsWith('10.')) ||
    candidates[0];
  return prefer || null;
}

function writeConfig(ip) {
  const cfgPath = path.resolve(__dirname, '..', 'src', 'config.ts');
  const content =
    `// Runtime configuration for the app. Generated by scripts/set-backend-ip.js\n` +
    `// If this file is wrong, edit it manually.\n` +
    `export const BACKEND_URL = 'http://${ip}:4000';\n`;
  fs.writeFileSync(cfgPath, content, { encoding: 'utf8' });
  console.log('[set-backend-ip] wrote', cfgPath, '->', `http://${ip}:4000`);
}

function writeWebEnv(ip) {
  try {
    const webEnvPath = path.resolve(__dirname, '..', '..', 'web', '.env');
    let text = '';
    if (fs.existsSync(webEnvPath)) {
      text = fs.readFileSync(webEnvPath, 'utf8');
      if (/^VITE_API_BASE=/m.test(text)) {
        text = text.replace(
          /^VITE_API_BASE=.*$/m,
          `VITE_API_BASE=http://${ip}:4000`,
        );
      } else {
        text = `VITE_API_BASE=http://${ip}:4000\n` + text;
      }
    } else {
      text = `VITE_API_BASE=http://${ip}:4000\n`;
    }
    fs.writeFileSync(webEnvPath, text, 'utf8');
    console.log('[set-backend-ip] updated web .env ->', `http://${ip}:4000`);
  } catch (e) {
    console.warn(
      '[set-backend-ip] failed to write web .env:',
      e && e.message ? e.message : e,
    );
  }
}

function main() {
  const ip = pickIPv4();
  if (!ip) {
    console.error(
      '[set-backend-ip] could not detect IPv4 address automatically.',
    );
    process.exitCode = 2;
    return;
  }
  writeConfig(ip);
  writeWebEnv(ip);
}

main();
